# Assets

## Kana outline pipeline

The guided writing outline data is generated from the StrokeSVG hiragana set.

**Workflow**

1. Update or add SVGs in `strokesvg/dist/hiragana/`.
2. Run the converter:
   ```bash
   python3 kana-loop/tools/convert_strokesvg_to_kanaoutline.py
   ```
   This writes `kana-loop/assets/data/kana_outline.json`.
   - To regenerate a single kana entry in-place (for example, after editing `strokesvg/dist/hiragana/お.svg`):
     ```bash
     python3 kana-loop/tools/convert_strokesvg_to_kanaoutline.py --kana お
     ```
3. Validate the output:
   ```bash
   python3 kana-loop/tools/validate_kana_outline.py
   ```
4. The app reads the JSON file directly, so no code changes are required when SVGs change.

## Yōon kana generation (きゃ/しゅ/etc.)

Yōon kana entries (two-character combos that end in a small ゃ/ゅ/ょ) are generated by
combining the base kana SVG with the small kana SVG.

**How it works**

1. The converter detects yōon by splitting two-character kana where the second character
   is one of `ゃ/ゅ/ょ` (`split_yoon_kana` in `kana-loop/tools/kana_outline_utils.py`).
2. The base kana SVG (`strokesvg/dist/hiragana/<base>.svg`) is parsed first, and its strokes
   are emitted in order.
3. The small kana SVG (`strokesvg/dist/hiragana/<small>.svg`) is parsed next. Each stroke’s
   path segments are scaled and translated into the base kana’s viewBox using the yōon
   layout config, then appended to the stroke list.

**Placement config**

Layout rules live in `kana-loop/assets/data/yoon_layouts.json`. The converter resolves a
`scale` and `offset` (x/y, in normalized viewBox units) via:

1. A per-`base` + `addon` entry in `layouts`.
2. A row entry in `rows` for the base kana.
3. The `defaults` block.

**Regenerating outlines**

Run the main converter to rebuild `kana_outline.json` (or use `--kana` for a single entry).
Any yōon updates in `yoon_layouts.json` require regenerating the outlines so the transformed
small-kana strokes are re-baked into the JSON.

**Formatting invariants (do not change lightly)**

* JSON is written by `save_json` in `kana-loop/tools/kana_outline_utils.py` using
  `json.dumps(..., ensure_ascii=False, indent=2)` and always ends with a trailing newline.
* Stroke order is deterministic: base kana strokes first, followed by transformed small-kana
  strokes, each numbered sequentially starting at 1.
* Stroke point ordering is derived from the SVG path commands as parsed; changing stroke
  grouping/order in the SVGs will change the output JSON.
* Coordinates are normalized into the source SVG viewBox (0–1 range) before writing, so
  edits must preserve valid viewBox dimensions.

## Kana outline overrides

Guided writing supports per-kana overrides so you can fix a single kana without regenerating
the full outline file. Overrides are applied after `kana_outline.json` is loaded, and the
last override loaded for a kana replaces the generated entry.

**Load order (later wins)**

1. `assets/data/kana_outline.json` (generated data)
2. `assets/data/kana_outline_overrides.json` (optional)
3. `assets/data/overrides/*.json` (optional, loaded in directory listing order)

### Override formats

Use one of the following formats:

**Single file with multiple entries**

`assets/data/kana_outline_overrides.json` can contain:

* An array of full kana entries, matching the structure from `kana_outline.json`.
* A dictionary keyed by kana, where each value is a full kana entry (the `kana` field is
  injected automatically).

Example (array):

```json
[
  {
    "kana": "お",
    "strokes": [
      { "path_hint": [], "start_hint": {}, "end_hint": {}, "rules": {} }
    ]
  }
]
```

Example (dictionary keyed by kana):

```json
{
  "お": {
    "strokes": [
      { "path_hint": [], "start_hint": {}, "end_hint": {}, "rules": {} }
    ]
  }
}
```

**Per-kana file**

Place a file like `assets/data/overrides/お.json` with a single kana entry:

```json
{
  "kana": "お",
  "strokes": [
    { "path_hint": [], "start_hint": {}, "end_hint": {}, "rules": {} }
  ]
}
```

Whichever entry is loaded last for a given kana replaces the generated data, so you can
quickly fix a single kana by dropping an override file in `assets/data/overrides/`.
